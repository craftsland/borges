# Fix tool

In order to perform some maintenance operations there's `borges-tool` in binary for (only Linux) and Docker container. This tool lets you:

* Get the list of known siva files from the database
* Delete siva files from disk and/or database
* Queue repositories to be downloaded again
* Move siva files from one bucketing level to another

If you are using the binary you need to have glusterfs libraries installed:

* Arch / Manjaro linux

```
pacman -S glusterfs
```

* Debian / Ubuntu

```
apt-get install glusterfs-common
```

* Fedora / RHEL / CentOS

```
yum install glusterfs-api
```

## Commands

### database

Retrieves the list of sivas in database. Specifically it gets all inits from repository references. The database connection can be specified with `--database` option or with `BORGES_DATABASE` environment variable:

```
borges-tool database --database "postgres://testing:testing@localhost:5432/testing" > list.txt
```

### delete

Deletes siva files from the filesystem and references in the database contained in those files. If database or filesystem is an empty string this step is skipped. For example, if only filesystem connection string is provided only files are deleted and database is left untouched. If database is specified it also outputs the repositories that had the deleted references.

Filesystem connection string can specify standard filesystem or glusterfs:

* filesystem

The form is `file:///path/to/directory`. It can be any directory accessible by the tool.

* gluster

Specified as `gluster://host/volume/directory`. `host` is one of the glusterfs machines that serve the desired volume. `directory` can me omitted if siva files or the root for buckets is the volume root.


```
borges-tool delete --database="postgres://testing:testing@localhost:5432/testing" \
    --fs="gluster://gfs.host.com/volume/directory" --bucket=2 \
    --workers=4 --skip-errors --output=repositories.txt list.txt
```

### queue

This command adds new jobs to download the repositories from the provided list. The list has to contain repository uuids, for example the output of `delete` command. Only the repositories in `fetching` or `fetched` status are queued. Before proceeding to queue repositories the list is sorted and duplicates are eliminated. The queue can be specified with `--broker` and `--queue` parameters or `BORGES_BROKER` and `BORGES_QUEUE` environment variables.

```
borges-tool queue --database="postgres://testing:testing@localhost:5432/testing" \
    --broker="amqp://localhost:5672" --queue=borges \
    --workers=4 --skip-errors repositories.txt
```

### rebucket

Move siva files from one bucketing level to another. This movement must be done in the same filesystem. It outputs the list of siva files that had an error renaming. The positional parameters are `filesystemp`, `from`, `to` and siva list. `from` and `to` are the original and the desired bucketing levels. For example, to move siva files without bucketing to bucket level 2 in a glusterfs volume the command would be:

```
borges-tool rebucket --skip-errors --output=errors.txt --workers=8 \
    gluster://gfs.host.com/volume/directory 0 2 list.txt
```

## Common use cases

### Get the list of siva files in the filesystem

You can use `find` to get the list of all siva files stored in the filesystem and filtering afterwards. For example, if your siva files are in `/mnt/repositories` you can do:

```
find /mnt/repositories | grep -E '\.siva$' | sed 's|.*/||;s/\.siva$//' | sort -u > list.txt
```

To get the list of siva files in a certain bucket level you can check the size of directory after the root path. For example, for bucket level 2:

```
find /mnt/repositories | grep -E 'repositories/../.{40}\.siva$' | sed 's|.*/||;s/\.siva$//' | sort -u > list.txt
```

If you are using glusterfs you'd better get the list of files directly from the bricks as listing files in a mounted fuse FS can be very slow.

**Note:** As you can see the lists are generated with only the file name without the `.siva` suffix. You should do it like this as the lists generated by `borges-tool` commands have this format and you will be able to combine them.

### Delete sivas not in the filesystem

You first need to generate the list of siva files in the filesystem using previous instructions. Make sure that the list is ordered and does not contain duplicates. The previous commands to generate lists end in `sort -u` to make sure of that.

```
# get the list of siva files in the database, sort them and make unique
borges-tool database --database "postgres://testing:testing@localhost:5432/testing" | \
    sort -u > database.txt

# get the siva files in the database list but not in filesystem
comm -23 database.txt filesystem.txt > missing.txt

# delete sivas from the database and generate the list of repositories to queue
borges-tool delete --database="postgres://testing:testing@localhost:5432/testing" \
    --fs="" --bucket=2 --workers=4 --skip-errors --output=repositories.txt missing.txt

# queue repositories with missing sivas
borges-tool queue --database="postgres://testing:testing@localhost:5432/testing" \
    --broker="amqp://localhost:5672" --queue=borges \
    --workers=4 --skip-errors repositories.txt
```

### Merge siva files with two different bucketing levels

First you need to generate the lists with siva files from two bucketing levels, for example, merge sivas with bucketing 2 into sivas with bucketing 4 you can have them in lists `bucket2.txt` and `bucket4.txt`:

```
# get the list of duplicated siva files, these will be deleted as cannot be merged
comm -12 bucket2.txt bucket3.txt > both.txt

# delete duplicated siva files from disk and database, the second execution for
# sivas with bucketing 4 should output an empty list of repositories
borges-tool delete --database="postgres://testing:testing@localhost:5432/testing" \
    --fs="gluster://gfs.host.com/volume/directory" --bucket=2 --workers=4 \
    --skip-errors --output=repositories.txt both.txt
borges-tool delete --database="postgres://testing:testing@localhost:5432/testing" \
    --fs="gluster://gfs.host.com/volume/directory" --bucket=4 --workers=4 \
    --skip-errors both.txt

# queue repositories from the previous command
borges-tool queue --database="postgres://testing:testing@localhost:5432/testing" \
    --broker="amqp://localhost:5672" --queue=borges \
    --workers=4 --skip-errors repositories.txt

# move siva files from bucketing level
borges-tool rebucket gluster://gfs.host.com/volume/directory 2 4 bucket2.txt
```

